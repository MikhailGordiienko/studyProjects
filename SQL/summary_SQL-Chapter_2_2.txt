/* Tasks about SQL chapter 2.2 and my solutions.
The course "Интерактивный тренажер по SQL" from Stepic */

Info about tables used:
    table-1)
      name:
        genre
      columns:
        genre_id (Primary key)
        name_genre

    table-2)
      name:
        author
      columns:
        author_id (Primary key)
        name_author

    table-3)
      name:
        book
      columns:
        book_id (Primary key)
        title
        author_id (Foreign key from "author")
        genre_id (Foreign key from "genre")
        price
        amount


Task 2.2-1

Вывести название, жанр и цену тех книг, количество которых больше 8,
в отсортированном по убыванию цены виде.

My code

SELECT title, name_genre, price
FROM
    book INNER JOIN genre
    ON book.genre_id = genre.genre_id
WHERE amount > 8
ORDER BY price DESC;

***

Task 2.2-2

Вывести все жанры, которые не представлены в книгах на складе.

My code

SELECT name_genre FROM genre
WHERE name_genre NOT IN (
SELECT name_genre
FROM book INNER JOIN genre
    ON book.genre_id = genre.genre_id
GROUP BY name_genre);

***

Task 2.2-3

Есть список городов, хранящийся в таблице city:

city_id	name_city
1	Москва
2	Санкт-Петербург
3	Владивосток
Необходимо в каждом городе провести выставку книг каждого автора в течение 2020 года.
Дату проведения выставки выбрать случайным образом. Создать запрос, который выведет
город, автора и дату проведения выставки. Последний столбец назвать Дата. Информацию
вывести, отсортировав сначала в алфавитном порядке по названиям городов, а потом по
убыванию дат проведения выставок.

My code

SELECT name_city, name_author,
DATE_FORMAT( FROM_UNIXTIME(RAND()*(1609372800 - 1577836800) + 1577836800) , '%d %M %Y' ) AS Дата
FROM city, author
ORDER BY name_city, Дата DESC

(Note: to get a random date, you need to use queries
    SELECT FROM_UNIXTIME(RAND() * (DateEnd - DateStart) + DateStart)
 Where DateEnd end DateStart you can get like
    SELECT
        UNIX_TIMESTAMP('2011-01-01') AS START, // 2011-01-01, 2011-12-31 for example
        UNIX_TIMESTAMP('2011-12-31') AS END;
 )
 __________________________________________________________________

 Another solution

 SELECT name_city, name_author,
 DATE_ADD("2020-01-01", INTERVAL (FLOOR(RAND() * 365)) DAY) AS Дата
 FROM city, author
 ORDER BY name_city, Дата DESC

***

Task 2.2-4

Вывести информацию о книгах (жанр, книга, автор), относящихся к жанру,
включающему слово «роман» в отсортированном по названиям книг виде.

My code

SELECT name_genre, title, name_author
FROM
    author
    INNER JOIN book ON author.author_id = book.author_id
    INNER JOIN genre ON book.genre_id = genre.genre_id
WHERE name_genre LIKE "%роман%"
ORDER BY title

***

Task 2.2-5

Посчитать количество экземпляров  книг каждого автора из таблицы author.
Вывести тех авторов,  количество книг которых меньше 10, в отсортированном
по возрастанию количества виде. Последний столбец назвать Количество.

My code (option 1)

SELECT name_author, SUM(amount) AS Количество
FROM
    author LEFT JOIN book
    ON author.author_id = book.author_id
GROUP BY name_author
HAVING Количество < 10 OR Количество IS NULL
ORDER BY Количество

My code (option 2)

SELECT name_author, IF(SUM(amount) IS NULL, 0, SUM(amount)) AS Количество
FROM
    author LEFT JOIN book
    ON author.author_id = book.author_id
GROUP BY name_author
HAVING Количество < 10
ORDER BY Количество

***

Task 2.2-6

Вывести в алфавитном порядке всех авторов, которые пишут только в одном жанре.
Поскольку у нас в таблицах так занесены данные, что у каждого автора книги только
в одном жанре,  для этого запроса внесем изменения в таблицу book. Пусть у нас
книга Есенина «Черный человек» относится к жанру «Роман», а книга Булгакова «Белая гвардия»
к «Приключениям» (эти изменения в таблицы уже внесены).

My code

SELECT name_author
FROM
    author
    INNER JOIN book
    ON author.author_id = book.author_id
    INNER JOIN genre
    ON book.genre_id = genre.genre_id
GROUP BY author.author_id
HAVING COUNT(DISTINCT(name_genre)) = 1
